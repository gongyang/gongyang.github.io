<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/09/hello-world/" class="article-date">
  <time datetime="2016-10-09T08:54:04.635Z" itemprop="datePublished">2016-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/09/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/09/hello-world/" data-id="ciu2e2hud00001ohp9jkcufui" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-php-cgi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/25/php-cgi/" class="article-date">
  <time datetime="2016-09-24T16:00:00.000Z" itemprop="datePublished">2016-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/25/php-cgi/">使用Spawn-FCGI管理php-cgi</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="使用Spawn-FCGI管理php-cgi"><a href="#使用Spawn-FCGI管理php-cgi" class="headerlink" title="使用Spawn-FCGI管理php-cgi"></a>使用Spawn-FCGI管理php-cgi</h2><p>最近在使用nginx的过程中，遇到一个用php来处理动态请求的情况，以前也没接触过php，其中有些概念，还真是有些多，今天特意整理了一下。</p>
<p>我们知道，nginx web服务器只是内容的分发者，早先的web服务器处理静态请求比较多，如果请求/index.html，那么web server会去文件系统中找到这个文件，发送给浏览器，这里分发的是静态数据。但是如果现在请求的是/index.php，根据配置文件，nginx知道这个不是静态文件，需要去找PHP解析器来处理，那么他会把这个请求简单处理后交给PHP解析器。</p>
<p> Nginx会传哪些数据给PHP解析器呢？url要有吧，查询字符串也得有吧，POST数据也要有，HTTP header不能少吧，好的，CGI就是规定要传哪些数据、以什么样的格式传递给后方处理这个请求的协议。</p>
<h3 id="CGI"><a href="#CGI" class="headerlink" title="CGI"></a>CGI</h3><p>通用网关接口（Common Gateway Interface/CGI）描述了客户端和服务器程序之间传输数据的一种标准，可以让一个客户端，从网页浏览器向执行在网络服务器上的程序请求数据。CGI 独立于任何语言的，CGI 程序可以用任何脚本语言或者是完全独立编程语言实现，只要这个语言可以在这个系统上运行。Unix shell script, Python, Ruby, PHP, perl, Tcl, C/C++, 和 Visual Basic 都可以用来编写 CGI 程序。</p>
<p>当web server收到/index.php这个请求后，会启动对应的CGI程序（php-cgi），这里就是PHP的解析器。接下来PHP解析器会解析php.ini文件，初始化执行环境，然后处理请求，再以规定CGI规定的格式返回处理后的结果，退出进程。web server再把结果返回给浏览器。</p>
<p>CGI使外部程序与Web服务器之间交互成为可能。CGI程式运行在独立的进程中，并对每个Web请求建立一个进程，这种方法非常容易实现，但效率很差，难以扩展。面对大量请求，进程的大量建立和消亡使操作系统性能大大下降。此外，由于地址空间无法共享，也限制了资源重用。这个时候FashCGI应运而生。</p>
<h3 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h3><p>快速通用网关接口（Fast Common Gateway Interface／FastCGI）是通用网关接口（CGI）的改进，描述了客户端和服务器程序之间传输数据的一种标准。FastCGI致力于减少Web服务器与CGI程式之间互动的开销，从而使服务器可以同时处理更多的Web请求。与为每个请求创建一个新的进程不同，FastCGI使用持续的进程来处理一连串的请求。这些进程由FastCGI进程管理器管理，而不是web服务器。</p>
<p>那么Fastcgi是怎么做的呢？<br>首先，Fastcgi会先启一个master，解析配置文件，初始化执行环境，然后再启动多个worker。当请求过来时，master会传递给一个worker，然后立即可以接受下一个请求。这样就避免了重复的劳动，效率自然是高。而且当worker不够用时，master可以根据配置预先启动几个worker等着；当然空闲worker太多时，也会停掉一些，这样就提高了性能，也节约了资源。这就是fastcgi的对进程的管理。<br>CGI 就是所谓的短生存期应用程序，FastCGI 就是所谓的长生存期应用程序。FastCGI像是一个常驻(long-live)型的CGI，它可以一直执行着，不会每次都要花费时间去fork一次(这是CGI最为人诟病的fork-and-execute 模式)。</p>
<h3 id="php-cgi"><a href="#php-cgi" class="headerlink" title="php-cgi"></a>php-cgi</h3><p>php-cgi是PHP自带的FastCGI进程，它是php程序的解析器<br>，本身只能解析请求，返回结果，并不会进程管理，所以才会出现了一些能够调度php-cgi进程的程序，比如PHP-FPM、Spawn-FCGI。</p>
<h3 id="PHP-FPM、Spawn-FCGI"><a href="#PHP-FPM、Spawn-FCGI" class="headerlink" title="PHP-FPM、Spawn-FCGI"></a>PHP-FPM、Spawn-FCGI</h3><p>PHP-FPM、Spawn-FCGI都是守护php-cgi进程的进程管理器。</p>
<p>Spawn-FCGI安装比较简单，使用起来也比较方便，官方<a href="http://www.lighttpd.net/download/" target="_blank" rel="external">下载地址</a>。<br>安装完成之后使用如下命令启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/bin/spawn-fcgi -a 127.0.0.1 -p 9000 -C 5 -u www-data -g www-data -f /usr/bin/php-CGI</div></pre></td></tr></table></figure></p>
<p>参数含义如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-f 指定调用FastCGI的进程的执行程序位置，根据系统上所装的PHP的情况具体设置</div><div class="line">　　-a 绑定到地址addr</div><div class="line">　　-p 绑定到端口port</div><div class="line">　　-s 绑定到unix socket的路径path</div><div class="line">　　-C 指定产生的FastCGI的进程数，默认为5(仅用于PHP)</div><div class="line">　　-P 指定产生的进程的PID文件路径</div><div class="line">　　-u和-g FastCGI使用什么身份(-u 用户 -g 用户组)运行</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>CGI、FastCGI是一种协议，PHP-FPM和Spawn-FCGI是实现了这个协议的一种软件。php-cgi只是解释PHP脚本的程序而已。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/25/php-cgi/" data-id="ciu2e80fw000n7rhpiwsldi5i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ngxtop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/17/ngxtop/" class="article-date">
  <time datetime="2016-09-16T16:00:00.000Z" itemprop="datePublished">2016-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/17/ngxtop/">ngxtop---nginx日志实时监控工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ngxtop—nginx日志实时监控工具"><a href="#ngxtop—nginx日志实时监控工具" class="headerlink" title="ngxtop—nginx日志实时监控工具"></a>ngxtop—nginx日志实时监控工具</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在工作当中，我们会经常通过tail -f去实时查看nginx的日志，但是这样很难提取到有用的信息，今天我们就来介绍一个好用的工具，<a href="https://github.com/lebinh/ngxtop" target="_blank" rel="external">ngxtop</a>。<br>ngxtop是一个实时查看nginx日志，并能对其进行分析的工具，它的输出有点类似于我们常用的top命令</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>由于ngxtop是用python编写的，首先得安装依赖库<a href="http://ask.xmodulo.com/install-pip-linux.html" target="_blank" rel="external">pip</a><br>然后我们使用如下命令安装ngxtop<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 ~]# pip install ngxtop</div></pre></td></tr></table></figure></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>我们使用ngxtop –help查看使用方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 ~]# ngxtop --help</div><div class="line">ngxtop - ad-hoc query for nginx access log.</div><div class="line"></div><div class="line">Usage:</div><div class="line">    ngxtop [options]</div><div class="line">    ngxtop [options] (print|top|avg|sum) &lt;var&gt; ...</div><div class="line">    ngxtop info</div><div class="line">    ngxtop [options] query &lt;query&gt; ...</div><div class="line"></div><div class="line">Options:</div><div class="line">    -l &lt;file&gt;, --access-log &lt;file&gt;  access log file to parse.</div><div class="line">    -f &lt;format&gt;, --log-format &lt;format&gt;  log format as specify in log_format directive. [default: combined]</div><div class="line">    --no-follow  ngxtop default behavior is to ignore current lines in log</div><div class="line">                     and only watch for new lines as they are written to the access log.</div><div class="line">                     Use this flag to tell ngxtop to process the current content of the access log instead.</div><div class="line">    -t &lt;seconds&gt;, --interval &lt;seconds&gt;  report interval when running in follow mode [default: 2.0]</div><div class="line"></div><div class="line">    -g &lt;var&gt;, --group-by &lt;var&gt;  group by variable [default: request_path]</div><div class="line">    -w &lt;var&gt;, --having &lt;expr&gt;  having clause [default: 1]</div><div class="line">    -o &lt;var&gt;, --order-by &lt;var&gt;  order of output for default query [default: count]</div><div class="line">    -n &lt;number&gt;, --limit &lt;number&gt;  limit the number of records included in report for top command [default: 10]</div><div class="line">    -a &lt;exp&gt; ..., --a &lt;exp&gt; ...  add exp (must be aggregation exp: sum, avg, min, max, etc.) into output</div><div class="line"></div><div class="line">    -v, --verbose  more verbose output</div><div class="line">    -d, --debug  print every line and parsed record</div><div class="line">    -h, --help  print this help message.</div><div class="line">    --version  print version information.</div><div class="line"></div><div class="line">    Advanced / experimental options:</div><div class="line">    -c &lt;file&gt;, --config &lt;file&gt;  allow ngxtop to parse nginx config file for log format and location.</div><div class="line">    -i &lt;filter-expression&gt;, --filter &lt;filter-expression&gt;  filter in, records satisfied given expression are processed.</div><div class="line">    -p &lt;filter-expression&gt;, --pre-filter &lt;filter-expression&gt; in-filter expression to check in pre-parsing phase.</div></pre></td></tr></table></figure></p>
<p><strong>实时监控日志</strong><br>ngxtop -l /usr/local/nginx/logs/access.log<br>这样，我们所看到的就类似于top命令一样的输出，当然我们可以加上-n参数，显示最多的几行信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">running for 8 seconds, 154 records processed: 19.01 req/sec</div><div class="line"></div><div class="line">Summary:</div><div class="line">|   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|---------+------------------+-------+-------+-------+-------|</div><div class="line">|     154 |          133.260 |    31 |   123 |     0 |     0 |</div><div class="line"></div><div class="line">Detailed:</div><div class="line">| request_path              |   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|---------------------------+---------+------------------+-------+-------+-------+-------|</div><div class="line">| /api/v1/patch             |	   89 |            0.607 |    12 |    77 |     0 |     0 |</div><div class="line">| /api/v1/tabbar_settings   |      35 |           12.229 |     4 |    31 |     0 |     0 |</div><div class="line">| /api/v1/carts             |      16 |          141.000 |    11 |     5 |     0 |     0 |</div><div class="line">| /api/v1/carts.json        |       6 |            0.000 |     0 |     6 |     0 |     0 |</div><div class="line">| /api/v1/orders/stats.json |       4 |            0.000 |     0 |     4 |     0 |     0 |</div></pre></td></tr></table></figure></p>
<p>如果要分析以前的日志，我们可以加上–no-follow参数，默认是分析实时的日志，而不会分析以前的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@bhqa logs]# ngxtop -l passport-access.log --no-follow</div><div class="line">running for 4 seconds, 46051 records processed: 13119.42 req/sec</div><div class="line"></div><div class="line">Summary:</div><div class="line">|   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|---------+------------------+-------+-------+-------+-------|</div><div class="line">|   46051 |          628.178 | 38283 |  4024 |  3642 |   102 |</div><div class="line"></div><div class="line">Detailed:</div><div class="line">| request_path                              |   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|-------------------------------------------+---------+------------------+-------+-------+-------+-------|</div><div class="line">| /api/v1/users/(null)                      |   13094 |          307.985 | 12910 |     2 |   178 |     4 |</div><div class="line">| /api/v1/users/login                       |    7395 |          320.068 |  6211 |     0 |  1181 |     3 |</div><div class="line">| /login                                    |    6153 |         1989.940 |  6083 |    33 |    27 |    10 |</div><div class="line">| /admin/sessions                           |    3355 |          462.457 |   489 |  2791 |    75 |     0 |</div><div class="line">| /api/v1/user_connections.json             |    2011 |           94.427 |  1864 |   124 |    14 |     9 |</div><div class="line">| /api/v1/users/3819                        |    1378 |          344.372 |  1377 |     0 |     1 |     0 |</div><div class="line">| /api/v1/user_connections/authenticate_sns |    1219 |          827.696 |  1132 |     0 |    48 |    39 |</div><div class="line">| /api/v1/user_connections                  |     999 |          108.591 |   513 |   435 |    49 |     2 |</div><div class="line">| /api/v1/users/14                          |     798 |          348.147 |   798 |     0 |     0 |     0 |</div><div class="line">| /admin/users                              |     716 |         1285.564 |   444 |   249 |    23 |     0 |</div></pre></td></tr></table></figure></p>
<p>我们还可以使用-g -o参数对结果进行group和order<br><strong>order-by</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@bhqa logs]# ngxtop -l passport-access.log --no-follow -o &quot;avg_bytes_sent&quot;</div><div class="line">running for 4 seconds, 46051 records processed: 13151.85 req/sec</div><div class="line"></div><div class="line">Summary:</div><div class="line">|   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|---------+------------------+-------+-------+-------+-------|</div><div class="line">|   46051 |          628.178 | 38283 |  4024 |  3642 |   102 |</div><div class="line"></div><div class="line">Detailed:</div><div class="line">| request_path                  |   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|-------------------------------+---------+------------------+-------+-------+-------+-------|</div><div class="line">| /admin/administrators/64/edit |       1 |         3409.000 |     1 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/20/edit |       1 |         3402.000 |     1 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/46/edit |       2 |         3398.000 |     2 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/71/edit |       3 |         3387.667 |     3 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/69/edit |       1 |         3384.000 |     1 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/56/edit |       3 |         3374.333 |     3 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/63/edit |       4 |         3308.500 |     4 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/66/edit |       3 |         3058.333 |     3 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/36/edit |       1 |         3053.000 |     1 |     0 |     0 |     0 |</div><div class="line">| /admin/administrators/54/edit |       7 |         2954.714 |     7 |     0 |     0 |     0 |</div></pre></td></tr></table></figure></p>
<p><strong>group-by</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@bhqa logs]# ngxtop -l passport-access.log --no-follow -g remote_addr</div><div class="line">running for 3 seconds, 46051 records processed: 13252.85 req/sec</div><div class="line"></div><div class="line">Summary:</div><div class="line">|   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|---------+------------------+-------+-------+-------+-------|</div><div class="line">|   46051 |          628.178 | 38283 |  4024 |  3642 |   102 |</div><div class="line"></div><div class="line">Detailed:</div><div class="line">| remote_addr    |   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</div><div class="line">|----------------+---------+------------------+-------+-------+-------+-------|</div><div class="line">| 58.246.136.4   |   29045 |          563.002 | 23989 |  3199 |  1795 |    62 |</div><div class="line">| 58.246.136.2   |   11409 |          530.525 |  9520 |   641 |  1218 |    30 |</div><div class="line">| 127.0.0.1      |     224 |          139.362 |   185 |     0 |    39 |     0 |</div><div class="line">| 211.22.145.234 |     215 |          307.242 |   214 |     1 |     0 |     0 |</div><div class="line">| 101.80.45.210  |     170 |          335.000 |   170 |     0 |     0 |     0 |</div><div class="line">| 222.65.137.160 |     149 |          259.685 |   144 |     0 |     5 |     0 |</div><div class="line">| 116.230.205.93 |     116 |          338.828 |   116 |     0 |     0 |     0 |</div><div class="line">| 101.229.195.1  |     108 |          314.370 |   100 |     0 |     8 |     0 |</div><div class="line">| 180.164.242.31 |     104 |          474.654 |    53 |     0 |    51 |     0 |</div><div class="line">| 114.88.231.181 |      90 |          264.633 |    89 |     0 |     1 |     0 |</div></pre></td></tr></table></figure></p>
<p><strong>显示400或更高返回状态码</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@bhqa logs]# ngxtop -l passport-access.log --no-follow -n 5 -i &apos;status &gt;=400&apos; print remote_addr status </div><div class="line">running for 4 seconds, 3744 records processed: 972.38 req/sec</div><div class="line"></div><div class="line">remote_addr, status:</div><div class="line">| remote_addr     |   status |</div><div class="line">|-----------------+----------|</div><div class="line">| 1.188.172.188   |      401 |</div><div class="line">| 101.226.227.95  |      404 |</div><div class="line">| 101.226.33.201  |      404 |</div><div class="line">| 101.226.33.216  |      404 |</div><div class="line">| 101.226.33.219  |      404 |</div><div class="line">| 101.226.51.226  |      404 |</div><div class="line">| 101.226.64.174  |      404 |</div><div class="line">| 101.226.65.104  |      499 |</div><div class="line">| 101.226.66.191  |      404 |</div><div class="line">| 101.229.17.2    |      404 |</div><div class="line">| 101.229.195.1   |      401 |</div><div class="line">| 101.229.30.8    |      404 |</div><div class="line">| 103.240.124.89  |      401 |</div><div class="line">| 107.191.53.74   |      401 |</div><div class="line">| 107.191.53.74   |      404 |</div><div class="line">| 108.61.200.226  |      404 |</div><div class="line">| 111.206.36.13   |      401 |</div><div class="line">| 112.224.67.54   |      400 |</div><div class="line">| 112.64.189.74   |      401 |</div><div class="line">| 112.64.235.247  |      500 |</div><div class="line">| 112.64.235.91   |      404 |</div></pre></td></tr></table></figure></p>
<p>另外一些变量可以在分析时用到，名字含义同日志格式里的设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">remote_addr、remote_user、time_local、request、request_path、status、body_bytes_sent、http_referer、http_user_agent</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/17/ngxtop/" data-id="ciu2e80fp000l7rhpkpi43w7p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-conntrack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/04/conntrack/" class="article-date">
  <time datetime="2016-09-03T16:00:00.000Z" itemprop="datePublished">2016-09-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/04/conntrack/">系统内核参数--nf_conntrack</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="系统内核参数–nf-conntrack"><a href="#系统内核参数–nf-conntrack" class="headerlink" title="系统内核参数–nf_conntrack"></a>系统内核参数–nf_conntrack</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>nf_conntrack 是 iptables 防火墙模块，它是用于跟踪一个连接的状态的模块。</p>
<p>由于nf_conntrack 工作在3层，支持IPv4和IPv6，而ip_conntrack只支持IPv4，因此nf_conntrack模块在Linux的2.6.15内核中被引入，而ip_conntrack在Linux的2.6.22内核被移除（centos6.x版本），因此不同版本的系统，配置文件也就不尽相同了。目前大多的ip<em>conntrack</em><em>已被 nf<em>conntrack</em></em> 取代，很多ip<em>conntrack</em>*仅仅是个软链接，原先的ip_conntrack配置目录/proc/sys/net/ipv4/netfilter/ 仍然存在，但是新的nf_conntrack在/proc/sys/net/netfilter/中，这样做是为了能够向下的兼容。</p>
<p>ip_conntrack 模块会记录每一个tcp数据包的estiablished,timewait,syn_recv等状态。最常见的两个使用场景是 iptables的nat和state模块。</p>
<p>iptables 的 nat 通过规则来修改目的、源地址，但光修改地址不行，我们还需要能让回来的包能路由到最初的来源主机。这就需要借助 nf_conntrack 来找到原来那个连接的记录才行。<br>而 state 模块则是直接使用 nf_conntrack 里记录的连接的状态来匹配用户定义的相关规则。</p>
<h3 id="参数设定"><a href="#参数设定" class="headerlink" title="参数设定"></a>参数设定</h3><p>kernel 用 ip_conntrack 模块来记录 iptables 网络包的状态，并把每条记录保存到 table 里（这个 table 在内存里，可以通过/proc/net/ip_conntrack 查看当前已经记录的总数），如果网络状况繁忙，比如高连接，高并发连接等会导致逐步占用这个 table 可用空间，一般这个 table 很大不容易占满并且可以自己清理，table 的记录会一直呆在 table 里占用空间直到源 IP 发一个 RST 包，但是如果出现被攻击、错误的网络配置、有问题的路由/路由器、有问题的网卡等情况的时候，就会导致源 IP 发的这个 RST 包收不到，这样就积累在 table 里，越积累越多直到占满，满了以后 iptables 就会丢包，出现外部无法连接服务器的情况。内核会报如下错误信息：kernel: ip_conntrack: table full, dropping packet.</p>
<p>系统当前连接可以查看/proc/net/nf_conntrack<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 ~]# cat /proc/net/nf_conntrack</div><div class="line">ipv4     2 tcp      6 299 ESTABLISHED src=192.168.168.1 dst=192.168.168.11 sport=53635 dport=22 src=192.168.168.11 dst=192.168.168.1 sport=22 dport=53635 [ASSURED] mark=0 secmark=0 use=3</div><div class="line">ipv4     2 udp      17 28 src=192.168.1.4 dst=192.168.1.255 sport=137 dport=137 [UNREPLIED] src=192.168.1.255 dst=192.168.1.4 sport=137 dport=137 mark=0 secmark=0 use=2</div><div class="line">ipv4     2 udp      17 28 src=192.168.1.1 dst=255.255.255.255 sport=38632 dport=7423 [UNREPLIED] src=255.255.255.255 dst=192.168.1.1 sport=7423 dport=38632 mark=0 secmark=0 use=2</div></pre></td></tr></table></figure></p>
<p>系统当前参数值可以通过syscrl -a来查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 ~]# sysctl -a | grep nf_conntrack</div><div class="line">net.netfilter.nf_conntrack_generic_timeout = 600</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 4000</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_close = 10</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300</div><div class="line">net.netfilter.nf_conntrack_tcp_loose = 1</div><div class="line">net.netfilter.nf_conntrack_tcp_be_liberal = 0</div><div class="line">net.netfilter.nf_conntrack_tcp_max_retrans = 3</div><div class="line">net.netfilter.nf_conntrack_udp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_udp_timeout_stream = 180</div><div class="line">net.netfilter.nf_conntrack_icmpv6_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_icmp_timeout = 30</div><div class="line">net.netfilter.nf_conntrack_acct = 0</div><div class="line">net.netfilter.nf_conntrack_events = 1</div><div class="line">net.netfilter.nf_conntrack_events_retry_timeout = 15</div><div class="line">net.netfilter.nf_conntrack_max = 200000</div><div class="line">net.netfilter.nf_conntrack_count = 4</div><div class="line">net.netfilter.nf_conntrack_buckets = 16384</div><div class="line">net.netfilter.nf_conntrack_checksum = 1</div><div class="line">net.netfilter.nf_conntrack_log_invalid = 0</div><div class="line">net.netfilter.nf_conntrack_expect_max = 256</div><div class="line">net.ipv6.nf_conntrack_frag6_timeout = 60</div><div class="line">net.ipv6.nf_conntrack_frag6_low_thresh = 3145728</div><div class="line">net.ipv6.nf_conntrack_frag6_high_thresh = 4194304</div><div class="line">net.nf_conntrack_max = 200000</div></pre></td></tr></table></figure></p>
<p>以上的内容实际在/proc/sys/net/netfilter都有对应的文件配置。</p>
<p>对于普通的服务器来说，默认参数不会影响正常使用，但如果是对外web服务器，我们通常要修改这几个值。<br><strong>直接设置：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 ~]# sysctl -w net.netfilter.nf_conntrack_max=100000</div><div class="line">net.netfilter.nf_conntrack_max = 100000</div><div class="line">[root@gy-vm02 ~]# sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=3600</div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 3600</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 ~]# echo &quot;3600&quot; &gt; /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_established </div><div class="line">[root@gy-vm02 ~]# echo &quot;100000&quot; &gt; /proc/sys/net/netfilter/nf_conntrack_max</div></pre></td></tr></table></figure></p>
<p><strong>修改配置文件：</strong><br>打开配置文件sysctl.conf <figure class="highlight vim"><figcaption><span>/etc/sysctl.conf``` 加入上面需要修改的信息</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line">net.netfilter.nf_conntrack_max = <span class="number">100000</span></div><div class="line">net.netfilter.nf_conntrack_tcp_timeout_established = <span class="number">3600</span></div></pre></td></tr></table></figure></p>
<p>然后使用<code>sysctl -p</code> 生效。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/04/conntrack/" data-id="ciu2e80eu00047rhpqacfdtgj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tmpwatch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/28/tmpwatch/" class="article-date">
  <time datetime="2016-08-27T16:00:00.000Z" itemprop="datePublished">2016-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/28/tmpwatch/">tmpwatch</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="tmpwatch"><a href="#tmpwatch" class="headerlink" title="tmpwatch"></a>tmpwatch</h2><p>什么是tmpwatch？<br>tmpwatch - removes files which haven’t been accessed for a period of time<br>就是对一段时间内没有访问过的文件进行删除。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>直接使用yum进行安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install tmpwatch</div></pre></td></tr></table></figure></p>
<p>安装完成之后，会在/etc/cron.daily/目录下生成一个tmpwatch的文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 cron.daily]# cat tmpwatch </div><div class="line">#! /bin/sh</div><div class="line">flags=-umc</div><div class="line">/usr/sbin/tmpwatch &quot;$flags&quot; -x /tmp/.X11-unix -x /tmp/.XIM-unix \</div><div class="line">	-x /tmp/.font-unix -x /tmp/.ICE-unix -x /tmp/.Test-unix \</div><div class="line">	-X &apos;/tmp/hsperfdata_*&apos; 10d /tmp</div><div class="line">/usr/sbin/tmpwatch &quot;$flags&quot; 30d /var/tmp</div><div class="line">for d in /var/&#123;cache/man,catman&#125;/&#123;cat?,X11R6/cat?,local/cat?&#125;; do</div><div class="line">    if [ -d &quot;$d&quot; ]; then</div><div class="line">	/usr/sbin/tmpwatch &quot;$flags&quot; -f 30d &quot;$d&quot;</div><div class="line">    fi</div><div class="line">done</div></pre></td></tr></table></figure></p>
<p>/usr/sbin/tmpwatch <figure class="highlight plain"><figcaption><span>-f 30d "$d" ```这一行，就是说清理30天没有被访问过的文件或文件夹</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### tmpwatch参数说明：</div></pre></td></tr></table></figure></p>
<p>-u, –atime 基于访问时间来删除文件，默认的。<br>-m, –mtime 基于修改时间来删除文件。<br>-c, –ctime 基于创建时间来删除文件，对于目录，基于mtime。<br>-M, –dirmtime 删除目录基于目录的修改时间而不是访问时间。<br>-a, –all 删除所有的文件类型，不只是普通文件，符号链接和目录。<br>-d, –nodirs 不尝试删除目录，即使是空目录。<br>-d, –nosymlinks 不尝试删除符号链接。<br>-f, –force 强制删除。<br>-q, –quiet 只报告错误信息。<br>-s, –fuser 如果文件已经是打开状态在删除前，尝试使用“定影”命令。默认不启用。<br>-t, –test 仅作测试，并不真的删除文件或目录。<br>-U, –exclude-user=user 不删除属于谁的文件。<br>-v, –verbose 打印详细信息。<br>-x, –exclude=path 排除路径，如果路径是一个目录，它包含的所有文件被排除了。如果路径不存在，它必须是一个绝对路径不包含符号链接。<br>-X, –exclude-pattern=pattern 排除某规则下的路径。</p>
<p>```</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/28/tmpwatch/" data-id="ciu2e80gg000t7rhpz01a7ywv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-puppet" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/21/puppet/" class="article-date">
  <time datetime="2016-08-20T16:00:00.000Z" itemprop="datePublished">2016-08-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/21/puppet/">puppet 安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="puppet-安装"><a href="#puppet-安装" class="headerlink" title="puppet 安装"></a>puppet 安装</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>puppet是一个开源的软件自动化配置和部署工具，它使用简单且功能强大，现在很多大型IT公司均在使用puppet对集群中的软件进行管理和部署。</p>
<p>puppet是基于c/s架构的。服务器端保存着所有对客户端服务器的配置代码，在puppet里面叫做manifest. 客户端下载manifest之后，可以根据manifest对服务器进行配置，例如软件包管理，用户管理和文件管理等等。</p>
<p>puppet的工作流程分为以下10个步骤：<br>1.客户端通过facter收集客户端信息并发送至服务端。<br>2.连接服务端并请求catalog日志。</p>
<ol>
<li>请求节点（node）的信息.</li>
<li>从服务器端接收节点（node)的实例</li>
<li>编译代码（包括语法检查等工作）<br>6.查询是否有exported 虚拟资源</li>
<li>如有，则从数据库接收虚拟资源</li>
<li>接收完整的catalog日志</li>
<li>存储catalog日志到数据库<br>10.客户端接收完整的catalog日志。</li>
</ol>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><strong>环境说明：</strong><br>server：gy-vm02  ip：192,168.1.81<br>client：gy-vm03   ip：192.168.1.124</p>
<p>配置epel源，直接使用yum进行安装</p>
<p>server端：<br>yum -y install puppet puppet-server<br>安装目录默认存为/etc/puppet，该目录下的manifests存放manifest文件。<br>puppet.conf是主要的配置文件</p>
<p>client端：<br>yum -y install puppet</p>
<p>安装完成之后，我们在server端启动puppetmaster服务，并打开8140端口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 puppet]# /etc/init.d/puppetmaster start</div></pre></td></tr></table></figure></p>
<h3 id="client端进行认证"><a href="#client端进行认证" class="headerlink" title="client端进行认证"></a>client端进行认证</h3><p>首先在在server和client服务器的/etc/hosts里面添加对应hostname和ip。<br>然后在client上输入一下命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm03 ~]# puppetd --test --server gy-vm02</div><div class="line">info: Creating a new SSL key for gy-vm03</div><div class="line">info: Caching certificate for ca</div><div class="line">info: Creating a new SSL certificate request for gy-vm03</div><div class="line">info: Certificate Request fingerprint (SHA256): B1:E1:35:DB:28:D4:80:4A:F6:DF:CA:26:F1:F8:7C:53:71:D9:DB:B0:4C:C8:B9:EC:D1:77:FF:6F:C8:3C:8E:A7</div><div class="line">Exiting; no certificate found and waitforcert is disabled</div><div class="line">[root@gy-vm03 ~]#</div></pre></td></tr></table></figure></p>
<p>我们可以看到client发了一个认证</p>
<h3 id="服务器确认认证"><a href="#服务器确认认证" class="headerlink" title="服务器确认认证"></a>服务器确认认证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 puppet]# puppetca -a --list</div><div class="line">  &quot;gy-vm03&quot; (F6:D4:44:EE:D6:02:B4:51:F3:7F:F0:26:EE:89:28:8B)</div></pre></td></tr></table></figure>
<p>使用puppetca可以查看认证信息，我们可以看到有来至gy-vm03的认证信息<br>使用下面命令确认信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 puppet]# puppetca -s gy-vm03</div><div class="line">notice: Signed certificate request for gy-vm03</div><div class="line">notice: Removing file Puppet::SSL::CertificateRequest gy-vm03 at &apos;/var/lib/puppet/ssl/ca/requests/gy-vm03.pe</div></pre></td></tr></table></figure></p>
<p>再次查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@gy-vm02 puppet]# puppetca -a --list</div><div class="line">+ &quot;gy-vm03&quot; (E5:5E:A0:48:AC:BC:14:A4:60:66:E3:11:6C:03:CE:DF)</div></pre></td></tr></table></figure></p>
<p>注意前面的+号，说明已经签名</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>puppet的安装，使用 yum安装比较方便，puppet的配置也比较清楚，puppet语法可以<br>参阅ruby语法，总之来说，puppet安装与配置简单，但是puppet有很多资源模块需要化<br>时间去阅读</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/21/puppet/" data-id="ciu2e80fy000o7rhpgfmestdj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-08-13" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/13/08-13/" class="article-date">
  <time datetime="2016-08-12T16:00:00.000Z" itemprop="datePublished">2016-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/13/08-13/">在nginx层配置某段逻辑按照时间段生效</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="在nginx层配置某段逻辑按照时间段生效"><a href="#在nginx层配置某段逻辑按照时间段生效" class="headerlink" title="在nginx层配置某段逻辑按照时间段生效"></a>在nginx层配置某段逻辑按照时间段生效</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近遇到一个比较棘手的问题，发现每到零点的时候，有个应用的请求量飙升，导致后端服务器压力很大，CPU几乎耗尽。后面查到原因，是由于客户端造成的，虽然在后面的版本中修正了这个bug，但是还是有很多老用户，没有更新版本，导致问题一直持续。后面和客户端工程师沟通，对于晚上这些大量的请求，其实是可以在nginx直接应对的，只要返回一个200的状态码就可以了。当时的第一想法就是在nginx写一个策略，晚上0-4点对于那部分请求，直接在nginx返回一个200的状态码。<br>想要完成这个策略，需要解决两个问题，在nginx怎么获取时间值？多条件的判断怎么写？接下来，我们来一一解决。</p>
<h3 id="nginx获取时间信息"><a href="#nginx获取时间信息" class="headerlink" title="nginx获取时间信息"></a>nginx获取时间信息</h3><p>官方版本的nginx是没有可以直接用来获取时间的变量，不过淘宝开源的<a href="http://tengine.taobao.org/index_cn.html" target="_blank" rel="external">tengine</a>增加了相关的变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$unix_time    #当前时间戳，其值为1970年1月1日以来的秒数</div><div class="line">$year   #当前4位年（如2011）</div><div class="line">$year2   #当前2位年（如11）</div><div class="line">$month    #当前月份，有前导0（如12）</div><div class="line">$day    #当前日，有前导0（如22）</div><div class="line">$hour    #当前24小时制的小时，有前导0（如21）</div><div class="line">$hour12    #当前12小时制的小时，有前导0（如09）</div><div class="line">$minute    #当前分钟，有前导0（如55）</div><div class="line">$second    #当前秒，有前导0（如12）</div></pre></td></tr></table></figure></p>
<p>更多相关变量请<a href="http://tengine.taobao.org/document_cn/variables_cn.html" target="_blank" rel="external">点击查看</a></p>
<h3 id="nginx-如何支持与-amp-amp-和或-运算"><a href="#nginx-如何支持与-amp-amp-和或-运算" class="headerlink" title="nginx 如何支持与&amp;&amp;和或|| 运算"></a>nginx 如何支持与&amp;&amp;和或|| 运算</h3><p>nginx的配置中不支持if条件的逻辑与&amp;&amp; 逻辑或|| 运算 ，而且不支持if的嵌套语法，否则会报下面的错误：nginx: [emerg] invalid condition。<br>不如下面的写法是错误的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location ^~ /api/v2/step &#123;</div><div class="line">   if ($http_user_agent ~* &quot;Android/Volley&quot; &amp;&amp; $hour =&quot;00&quot;)</div><div class="line">   return 400;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正确写法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">location ^~ /api/v2/step &#123;</div><div class="line">      set $flag 0;</div><div class="line">         if ($http_user_agent ~* &quot;Android/Volley&quot;) &#123;</div><div class="line">           set $flag &quot;$&#123;flag&#125;1&quot;;</div><div class="line">         &#125;</div><div class="line">         if ($hour ~ &quot;00&quot;) &#123;</div><div class="line">           set $flag &quot;$&#123;flag&#125;2&quot;;</div><div class="line">         &#125;</div><div class="line">         if ($flag = &quot;012&quot;) &#123;</div><div class="line">           return 401;</div><div class="line">         &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那如何设置0-4点这个时间段，只需要把($hour ~ “00”)改一下就可以了，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">($hour ~ &quot;(00|01|02|03|04|20)&quot;)</div></pre></td></tr></table></figure></p>
<p>不过对于上面的逻辑，还有一个小问题，我们只是针对0-4点这个时间段，其他时间我们是没有进行任何处理的，这样的话会报错，所以最终配置是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">location ^~ /api/v2/step &#123;</div><div class="line">      set $flag 0;</div><div class="line">         if ($http_user_agent ~* &quot;Android/Volley&quot;) &#123;</div><div class="line">           set $flag &quot;$&#123;flag&#125;1&quot;;</div><div class="line">         &#125;</div><div class="line">         if ($hour ~ &quot;(00|01|02|03|04|20)&quot;) &#123;</div><div class="line">           set $flag &quot;$&#123;flag&#125;2&quot;;</div><div class="line">         &#125;</div><div class="line">         if ($flag = &quot;012&quot;) &#123;</div><div class="line">           return 401;</div><div class="line">         &#125;</div><div class="line">         proxy_pass  $app_server;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/13/08-13/" data-id="ciu2e80eh00007rhp5p97w6xl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-dstat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/07/dstat/" class="article-date">
  <time datetime="2016-08-06T16:00:00.000Z" itemprop="datePublished">2016-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/07/dstat/">dstat--多功能系统资源统计生成工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="dstat–多功能系统资源统计生成工具"><a href="#dstat–多功能系统资源统计生成工具" class="headerlink" title="dstat–多功能系统资源统计生成工具"></a>dstat–多功能系统资源统计生成工具</h2><p>dstat是一个用来替换vmstat、iostat、netstat、nfsstat和ifstat这些命令的工具，是一个全能系统信息统计工具，而且还可以通过使用插件扩展其功能。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>centos系统上直接使用yum安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install dstat</div></pre></td></tr></table></figure></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>使用语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dstat [-afv] [options..] [delay [count]]</div></pre></td></tr></table></figure></p>
<p>安装完成之后，我们就可以直接使用dstat了，默认参数是-cdngy，分别代表显示cpu、disk、net、page、system信息，还可以在命令后面加上输出间隔时间(delay)以及输出次数(count)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@bhqa ~]# dstat 3 5</div><div class="line">----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--</div><div class="line">usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw </div><div class="line"> 10   4  85   1   0   0|  46k   40k|   0     0 |5085B 3034B| 599  2316 </div><div class="line">  8   4  85   3   0   1|  24k  105k| 493B  965B|   0     0 |1744  2630 </div><div class="line"> 11   4  86   0   0   0|   0    23k|4642B 5476B|   0     0 |1653  2086 </div><div class="line">  7   3  90   0   0   0|   0     0 | 551B  738B|   0     0 |1523  1969 </div><div class="line">  7   3  90   0   0   0|   0    12k|1421B 1211B|   0     0 |1590  2010 </div><div class="line">  8   3  88   0   0   1|  67k 1365B|1607B 1008B|   0     0 |1592  1975</div></pre></td></tr></table></figure></p>
<p>其中cpu一栏中的hiq、siq分别为硬中断和软中断次数。<br>system一栏的int、csw分别为系统的中断次数（interrupt）和上下文切换（context switch）。<br>其他常用选项<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">-c：显示CPU系统占用，用户占用，空闲，等待，中断，软件中断等信息。 </div><div class="line">-C：当有多个CPU时候，此参数可按需分别显示cpu状态，例：-C 0,1 是显示cpu0和cpu1的信息。 </div><div class="line">-d：显示磁盘读写数据大小。 </div><div class="line">-D  和-C类似，默认是显示所有磁盘信息，使用-D可以指定查看单个磁盘的信息</div><div class="line">-n：显示网络状态。 </div><div class="line">-N eth1,total：有多块网卡时，指定要显示的网卡。 </div><div class="line">-l：显示系统负载情况。 </div><div class="line">-m：显示内存使用情况。 </div><div class="line">-g：显示页面使用情况。 </div><div class="line">-p：显示进程状态。 </div><div class="line">-s：显示交换分区使用情况。 </div><div class="line">-S：类似D/N。 </div><div class="line">-r：I/O请求情况。 </div><div class="line">-y：系统状态。 </div><div class="line">--ipc：显示ipc消息队列，信号等信息。 </div><div class="line">--socket：用来显示tcp udp端口状态。 </div><div class="line">-a：此为默认选项，等同于-cdngy。 </div><div class="line">-v：等同于 -pmgdsc -D total。 </div><div class="line">--output 文件：此选项也比较有用，可以把状态信息以csv的格式重定向到指定的文件中，以便日后查看。例：dstat --output /tmp/dstat.csv</div></pre></td></tr></table></figure></p>
<p>更多的参数请查看<a href="http://linux.die.net/man/1/dstat" target="_blank" rel="external">man dstat</a> 或者使用dstat -h来查看</p>
<p>除了常用的功能，dstat还支持插件提供而外功能。<br>通过输入命令dstat –list查看所有参数<br>上面internal是dstat本身自带的一些监控参数；<br>下面/usr/share/dstat中是dstat的插件，这些插件可以扩展dstat的功能，如可以监控电源（battery）、mysql等。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@bhqa ~]# dstat --list</div><div class="line">internal:</div><div class="line">	aio, cpu, cpu24, disk, disk24, disk24old, epoch, fs, int, int24, io, ipc, load, lock, mem, net, page, page24, </div><div class="line">	proc, raw, socket, swap, swapold, sys, tcp, time, udp, unix, vm</div><div class="line">/usr/share/dstat:</div><div class="line">	battery, battery-remain, cpufreq, dbus, disk-util, fan, freespace, gpfs, gpfs-ops, helloworld, innodb-buffer, </div><div class="line">	innodb-io, innodb-ops, lustre, memcache-hits, mysql-io, mysql-keys, mysql5-cmds, mysql5-conn, mysql5-io, </div><div class="line">	mysql5-keys, net-packets, nfs3, nfs3-ops, nfsd3, nfsd3-ops, ntp, postfix, power, proc-count, rpc, rpcd, </div><div class="line">	sendmail, snooze, thermal, top-bio, top-cpu, top-cputime, top-cputime-avg, top-io, top-latency, </div><div class="line">	top-latency-avg, top-mem, top-oom, utmp, vm-memctl, vmk-hba, vmk-int, vmk-nic, vz-cpu, vz-io, vz-ubc, wifi</div></pre></td></tr></table></figure></p>
<p>例如通过–top-(io|bio|cpu|cputime|cputime-avg|mem) 这几个选项，可以看到具体是那个用户那个进程占用了相关系统资源，对系统调优非常有效。如查看当前占用I/O、cpu、内存等最高的进程信息可以使用dstat –top-mem –top-io –top-cpu。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/07/dstat/" data-id="ciu2e80f4000a7rhpp0pqyrbn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-sar" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/28/sar/" class="article-date">
  <time datetime="2016-07-27T16:00:00.000Z" itemprop="datePublished">2016-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/28/sar/">linux 系统运维工具--sar</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="linux-系统运维工具–sar"><a href="#linux-系统运维工具–sar" class="headerlink" title="linux 系统运维工具–sar"></a>linux 系统运维工具–sar</h2><p>sar（System Activity Reporter系统活动情况报告）是目前 Linux 上最为全面的系统性能分析工具之一，可以从多方面对系统的活动进行报告，包括：文件的读写情况、系统调用的使用情况、磁盘I/O、CPU效率、内存使用状况等</p>
<h3 id="软件安装包"><a href="#软件安装包" class="headerlink" title="软件安装包"></a>软件安装包</h3><p>sar是由sysstat软件包提供，sysstat除了提供sar命令之外，还提供了下面命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/usr/bin/cifsiostat #统计CIFS协议的网络文件系统的 I/O状态数据。</div><div class="line">/usr/bin/iostat #输出CPU的统计信息和所有I/O设备的输入输出（I/O）统计信息。</div><div class="line">/usr/bin/mpstat #关于CPU的详细信息（单独输出或者分组输出）。</div><div class="line">/usr/bin/pidstat #关于运行中的进程/任务、CPU、内存等的统计信息。</div><div class="line">/usr/bin/sadf #用于以不同的数据格式（CVS或者XML）来格式化sar工具的输出。</div><div class="line">/usr/bin/sar #保存并输出不同系统资源（CPU、内存、IO、网络、内核等。。。）的详细信息。</div></pre></td></tr></table></figure></p>
<p>除此之外，安装sysstat包后，默认创建一个/etc/cron.d/sysstat文件，其默认内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Run system activity accounting tool every 10 minutes</div><div class="line">*/10 * * * * root /usr/lib64/sa/sa1 1 1</div><div class="line"># 0 * * * * root /usr/lib64/sa/sa1 600 6 &amp;</div><div class="line"># Generate a daily summary of process accounting at 23:53</div><div class="line">53 23 * * * root /usr/lib64/sa/sa2 -A</div></pre></td></tr></table></figure></p>
<p>sa1、sa2是两个shell脚本</p>
<ul>
<li>sa1：调用sadc（二进制文件），将数据收集到二进制日志文件的一个Shell脚本。sa1命令还确保每天使用不同的文件。每隔十分钟运行一次该命令，最好不要改这个值，这是对一般系统折中的值。二进制日志文件存放在/var/log/sa/目录下，命名为sa${DATE}，这个文件是一个二进制的文件，需要使用sar -f 接文件名来查看。sa1用作 sadc 的前端程序。</li>
<li>sa2：是将当日二进制日志文件中所有的数据转储到文本文件的另一个Shell脚本，参数-A是表示将所有sar的信息都写到文本并保存放在/var/log/sa/目录下，命名为sar${DATE}，这是一个纯文本文件，可以直接查看。sa2用作 sar 的前端程序。</li>
<li>sadc ：系统动态数据收集工具，收集的数据被写入一个二进制的文件中，它被用作 sar 工具的后端</li>
</ul>
<h3 id="sar命令格式"><a href="#sar命令格式" class="headerlink" title="sar命令格式"></a>sar命令格式</h3><p>sar [ -A ] [ -B ] [ -b ] [ -C ] [ -D ] [ -d ] [ -F [ MOUNT ] ] [ -H ] [ -h ] [ -p ] [ -q ] [ -R ] [ -r [ ALL ] ] [ -S ] [ -t ] [ -u [ ALL ] ] [ -V ] [ -v ] [ -W ] [ -w ] [ -y ] [ –sadc ] [ -I { int [,…] | SUM | ALL | XALL } ] [ -P { cpu [,…] | ALL } ] [ -m { keyword [,…] | ALL } ] [ -n { keyword [,…] | ALL } ] [ -j { ID | LABEL | PATH | UUID | … } ] [ -f [ filename ] | -o [ filename ] | -[0-9]+ ] [ -i interval ] [ -s [ hh:mm[:ss] ] ] [ -e [ hh:mm[:ss] ] ] [ interval [ count ] ]</p>
<ul>
<li>interval : 为取样时间间隔</li>
<li>count : 为输出次数，若省略此项，会一直输出下去<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">-A：所有报告的总和</div><div class="line">-u：输出CPU使用情况的统计信息</div><div class="line">-v：输出inode、文件和其他内核表的统计信息</div><div class="line">-d：输出每一个块设备的活动信息</div><div class="line">-r：输出内存和交换空间的统计信息</div><div class="line">-b：显示I/O和传送速率的统计信息</div><div class="line">-a：文件读写情况</div><div class="line">-c：输出进程统计信息，每秒创建的进程数</div><div class="line">-R：输出内存页面的统计信息</div><div class="line">-y：终端设备活动情况</div><div class="line">-w：输出系统交换活动信息</div><div class="line">-n：&#123;DEV|EDEV|NFS|NFSD|SOCK|ALL&#125;	分析输出网络设备状态统计信息。</div><div class="line">DEV	报告网络设备的统计信息</div><div class="line">EDEV	报告网络设备的错误统计信息</div><div class="line">NFS	报告 NFS 客户端的活动统计信息</div><div class="line">NFSD	报告 NFS 服务器的活动统计信息</div><div class="line">SOCK	报告网络套接字（sockets）的使用统计信息</div><div class="line">ALL	报告所有类型的网络活动统计信息</div><div class="line">-o：filename	将输出信息保存到文件 filename</div><div class="line">-f：filename	从文件 filename 读取数据信息。filename 是使用-o 选项时生成的文件。</div><div class="line">-s：hh:mm:ss	指定输出统计数据的起始时间</div><div class="line">-e：hh:mm:ss	指定输出统计数据的截至时间，默认为18:00:00</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="sar-常用举例"><a href="#sar-常用举例" class="headerlink" title="sar 常用举例"></a>sar 常用举例</h3><p><strong>CPU资源监控</strong><br>每3秒采集一次数据，总共采集10次，并将数据以二进制方式保存到文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[bhuser@bhqa ~]$ sar -u -o cpuinfo 3 10</div><div class="line">Linux 2.6.32-504.8.1.el6.x86_64 (bhqa) 	2016年07月28日 	_x86_64_	(2 CPU)</div><div class="line"></div><div class="line">00时35分50秒     CPU     %user     %nice   %system   %iowait    %steal     %idle</div><div class="line">00时35分53秒     all      8.70      0.00      3.24      1.54      0.00     86.52</div><div class="line">00时35分56秒     all      8.05      0.00      3.08      1.54      0.00     87.33</div><div class="line">00时35分59秒     all      8.58      0.00      3.26      1.37      0.00     86.79</div><div class="line">00时36分02秒     all      8.56      0.00      3.25      1.03      0.00     87.16</div><div class="line">00时36分05秒     all      8.61      0.00      3.79      3.44      0.00     84.17</div><div class="line">00时36分08秒     all      8.92      0.00      3.77      2.40      0.00     84.91</div><div class="line">00时36分11秒     all      9.23      0.00      3.25      0.85      0.00     86.67</div><div class="line">00时36分14秒     all      8.76      0.00      3.26      1.20      0.00     86.77</div><div class="line">00时36分17秒     all      9.56      0.00      3.75      0.51      0.00     86.18</div><div class="line">00时36分20秒     all      8.25      0.00      4.30      1.20      0.00     86.25</div><div class="line">平均时间:     all      8.72      0.00      3.50      1.51      0.00     86.27</div></pre></td></tr></table></figure></p>
<p>输出项说明：</p>
<p>CPU：all 表示统计信息为所有 CPU 的平均值。<br>%user：显示在用户级别(application)运行使用 CPU 总时间的百分比。<br>%nice：CPU用来执行有用户级别优先级别的任务的时间的百分比。<br>%system：在核心级别(kernel)运行所使用 CPU 总时间的百分比。<br>%iowait：显示用于等待I/O操作占用 CPU 总时间的百分比。<br>%steal：管理程序(hypervisor)为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。<br>%idle：显示 CPU 空闲时间占用 CPU 总时间的百分比。</p>
<ol>
<li>若 %iowait 的值过高，表示硬盘存在I/O瓶颈</li>
<li>若 %idle 的值高但系统响应慢时，有可能是 CPU 等待分配内存，此时应加大内存容量</li>
<li>若 %idle 的值持续低于10，则系统的 CPU 处理能力相对较低，表明系统中最需要解决的资源是 CPU 。<br>如果要查看二进制文件cpuinfo中的内容，需键入如下sar命令：<br>sar  -f cpuinfo</li>
</ol>
<p><strong>I/O信息监控</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[bhuser@bhqa ~]$ sar -b 2 5</div><div class="line">Linux 2.6.32-504.8.1.el6.x86_64 (bhqa) 	2016年07月28日 	_x86_64_	(2 CPU)</div><div class="line"></div><div class="line">00时56分53秒       tps      rtps      wtps   bread/s   bwrtn/s</div><div class="line">00时56分55秒     37.11      4.64     32.47     65.98    379.38</div><div class="line">00时56分57秒    540.51      0.00    540.51      0.00   8459.49</div><div class="line">00时56分59秒      2.05      0.00      2.05      0.00     16.41</div><div class="line">00时57分01秒      4.08      4.08      0.00    277.55      0.00</div><div class="line">00时57分03秒      1.03      0.00      1.03      0.00      8.25</div><div class="line">平均时间:    117.04      1.75    115.30     68.99   1774.13</div></pre></td></tr></table></figure></p>
<p>tps    每秒钟物理设备的 I/O 传输总量<br>rtps    每秒钟从物理设备请求读次数<br>wtps    每秒钟向物理设备请求写入次数<br>bread/s    每秒钟从物理设备 读入的数据量，单位为 块/s<br>bwrtn/s每秒钟向物理设备写入的数据量，单位为 块/s</p>
<p><strong>进程队列信息监控</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[bhuser@bhqa ~]$ sar -q 3 5</div><div class="line">Linux 2.6.32-504.8.1.el6.x86_64 (bhqa) 	2016年07月28日 	_x86_64_	(2 CPU)</div><div class="line"></div><div class="line">00时58分52秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15</div><div class="line">00时58分55秒         3      1077      0.00      0.00      0.00</div><div class="line">00时58分58秒         1      1077      0.00      0.00      0.00</div><div class="line">00时59分01秒         0      1077      0.00      0.00      0.00</div><div class="line">00时59分04秒         0      1077      0.00      0.00      0.00</div><div class="line">00时59分07秒         0      1077      0.00      0.00      0.00</div><div class="line">平均时间:         1      1077      0.00      0.00      0.00</div></pre></td></tr></table></figure></p>
<p>runq-sz：运行队列的长度（等待运行的进程数）<br>plist-sz：进程列表中tasks的数量<br>ldavg-1：最后1分钟的系统平均负载（System load average）<br>ldavg-5：过去5分钟的系统平均负载<br>ldavg-15：过去15分钟的系统平均负载</p>
<p><strong>inode、文件和其他内核表信息监控</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[bhuser@bhqa ~]$ sar -v 2 2</div><div class="line">Linux 2.6.32-504.8.1.el6.x86_64 (bhqa) 	2016年07月28日 	_x86_64_	(2 CPU)</div><div class="line"></div><div class="line">01时01分44秒 dentunusd   file-nr  inode-nr    pty-nr</div><div class="line">01时01分46秒    630020      6112    373635         1</div><div class="line">01时01分48秒    630021      6112    373634         1</div><div class="line">平均时间:    630020      6112    373634         1</div></pre></td></tr></table></figure></p>
<p>dentunusd：目录高速缓存中未被使用的条目数量<br>file-nr：文件句柄（file handle）的使用数量<br>inode-nr：索引节点句柄（inode handle）的使用数量<br>pty-nr：系统pty（伪终端）使用数量</p>
<p><strong>网络设备信息监控</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[bhuser@bhqa ~]$ sar -n DEV 2 3</div><div class="line">Linux 2.6.32-504.8.1.el6.x86_64 (bhqa) 	2016年07月28日 	_x86_64_	(2 CPU)</div><div class="line"></div><div class="line">01时20分32秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</div><div class="line">01时20分34秒        lo    380.83    380.83     22.92     22.92      0.00      0.00      0.00</div><div class="line">01时20分34秒      eth0      7.25      9.33      0.79      0.92      0.00      0.00      0.00</div><div class="line"></div><div class="line">01时20分34秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</div><div class="line">01时20分36秒        lo    383.42    383.42     23.32     23.32      0.00      0.00      0.00</div><div class="line">01时20分36秒      eth0     40.93     52.33     17.23      4.74      0.00      0.00      0.00</div><div class="line"></div><div class="line">01时20分36秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</div><div class="line">01时20分38秒        lo    365.98    365.98     21.63     21.63      0.00      0.00      0.00</div><div class="line">01时20分38秒      eth0      7.22      8.25      1.29      1.06      0.00      0.00      0.00</div><div class="line"></div><div class="line">平均时间:     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</div><div class="line">平均时间:        lo    376.72    376.72     22.62     22.62      0.00      0.00      0.00</div><div class="line">平均时间:      eth0     18.45     23.28      6.43      2.23      0.00      0.00      0.00</div></pre></td></tr></table></figure></p>
<p>IFACE    网络设备名<br>rxpck/s    每秒接收的包总数<br>txpck/s    每秒传输的包总数<br>rxkB/s    每秒接收的字节（byte）总数<br>txkB/s  每秒传输的字节（byte）总数<br>rxcmp/s    每秒接收压缩包的总数<br>txcmp/s    每秒传输压缩包的总数<br>rxmcst/s    每秒接收的多播（multicast）包的总数</p>
<p>更详细的请查看<a href="http://sebastien.godard.pagesperso-orange.fr/man_sar.html" target="_blank" rel="external">官方文档</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/28/sar/" data-id="ciu2e80gd000r7rhp5179poba" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-unicorn" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/24/unicorn/" class="article-date">
  <time datetime="2016-07-23T16:00:00.000Z" itemprop="datePublished">2016-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/24/unicorn/">使用unicorn-worker-killer限制unicorn使用内存大小</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="使用unicorn-worker-killer限制unicorn使用内存大小"><a href="#使用unicorn-worker-killer限制unicorn使用内存大小" class="headerlink" title="使用unicorn-worker-killer限制unicorn使用内存大小"></a>使用unicorn-worker-killer限制unicorn使用内存大小</h2><p>unicorn是<a href="https://en.wikipedia.org/wiki/Rack_(web_server_interface" target="_blank" rel="external">rack</a>)应用广泛使用的http server。不过unicorn有一个缺点，就是可能会无限的增加内存使用，<br>unicorn-worker-killer gem提供基于unicorn进程使用最大内存和最大请求数自动重启的功能。并且不会影响正常的连接请求，这对于网站应用的稳定性提供了保障。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>unicorn-worker-killer使用很简单，只需要在Gemfile中添加该gem就可以了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gem &apos;unicorn-worker-killer&apos;</div></pre></td></tr></table></figure></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>在config.ru添加以下内容，这里注意一点，配置要添加在“require ::File.expand_path(‘../config/environment’,  <strong>FILE</strong>)”之上。</p>
<p>限制内存大小<br><strong>Unicorn::WorkerKiller::Oom(memory_limit_min=(1024**3), memory_limit_max=(2*(1024**3)), check_cycle = 16, verbose = false)</strong></p>
<p>memory_limit_min和memory_limit_max指定了最大内存的一个范围值。实际值是由 rand()从memory_limit_min和memory_limit_max中间取一个值，这样做的好处就是为了防止所有work在同一个时间重启。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Unicorn self-process killer</div><div class="line">require &apos;unicorn/worker_killer&apos;</div><div class="line"></div><div class="line"># Max memory size (RSS) per worker</div><div class="line">use Unicorn::WorkerKiller::Oom, (300*(1024**2)), (350*(1024**2))</div></pre></td></tr></table></figure></p>
<p>unicorn-worker-killer还支持基于请求数来重启进程<br><strong>Unicorn::WorkerKiller::MaxRequests(max_requests_min=3072, max_requests_max=4096, verbose=false)</strong></p>
<p>max_requests_min和max_requests_max指定了最大请求数的一个范围值。实际值是由 rand()从max_requests_min和max_requests_max中间取一个值，同样这样也是为了防止所有work在同一个时间重启。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Unicorn self-process killer</div><div class="line">require &apos;unicorn/worker_killer&apos;</div><div class="line"></div><div class="line"># Max requests per worker</div><div class="line">use Unicorn::WorkerKiller::MaxRequests, 3000, 4000</div></pre></td></tr></table></figure>
<p>如果verbose设置为true，每一次的检查都会写到日志里面，日志级别为info。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/24/unicorn/" data-id="ciu2e80gi000u7rhpdlq3mo6v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/10/09/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2016/09/25/php-cgi/">使用Spawn-FCGI管理php-cgi</a>
          </li>
        
          <li>
            <a href="/2016/09/17/ngxtop/">ngxtop---nginx日志实时监控工具</a>
          </li>
        
          <li>
            <a href="/2016/09/04/conntrack/">系统内核参数--nf_conntrack</a>
          </li>
        
          <li>
            <a href="/2016/08/28/tmpwatch/">tmpwatch</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>